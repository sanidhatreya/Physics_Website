<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Without The Headache</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        :root {
            --bg-color: #0b101a;
            --accent-color: #00d4ff;
            --text-color: #ffffff;
            --secondary-text: #8892b0;
            --panel-bg: #162135;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            background-image: url("./space1.png");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .hero { text-align: center; padding: 40px 20px 20px; }

        .hero h1 {
        font-size: 4.5rem;
        font-weight: 800;
        letter-spacing: 6px;

        background: linear-gradient(135deg, #b3c41a, #749d14);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;

        text-shadow:
            0 0 10px rgba(217, 137, 61, 0.6),
            0 0 20px rgba(222, 126, 62, 0.4),
            0 0 40px rgba(122, 69, 16, 0.4);

        position: relative;
        }

        select, input[type="number"], input[type="range"] {
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 50px;
            border: 2px solid var(--accent-color);
            background: var(--panel-bg);
            color: white;
            outline: none;
        }

        input[type="number"] {
            width: 80px;
            text-align: center;
        }

        .controls-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .ui-panel {
            display: none;
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 15px;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        label { font-size: 0.8rem; color: var(--secondary-text); }

        .btn-toggle {
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid var(--accent-color);
            background: transparent;
            color: white;
            cursor: pointer;
        }

        .btn-toggle.active { background: var(--accent-color); color: #000; }

        #canvas-wrapper {
            width: 95%;
            max-width: 1350px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: #000;
            margin-top: 100px;

            opacity: 0;
            transform: translateY(70px);
            animation: dropdownFade 3.5s ease-out forwards;
            animation-delay: 2s;
        }

        #instruction-text {
            margin-top: 60px;
            max-width: 800px;
            text-align: center;
            color: var(--secondary-text);
            padding: 0 20px 40px;
        }

        @keyframes dropdownFade {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Panel animation */
    .ui-panel {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .ui-panel.show {
        opacity: 1;
        transform: translateY(0);
    }

    </style>
</head>
<body>

    <div class="hero">
        <h1>Physics, Without The Headache</h1>
    </div>

    <div style="height: 100px;"></div>

    <div class="controls-wrapper"
        style="opacity:0; transform: translateY(20px); animation: dropdownFade 3.5s ease-out forwards; animation-delay:0.9s;">
        <select id="sim-selector" onchange="handleTopicChange()">
            <option value="" selected disabled>Choose a topic</option>
            <option value="waves">Waves Interference Simulator</option>
            <option value="doubleslit">Young's Double Slit Experiment</option>
            <option value="stern">Stern Gerlach Experiment</option>
            <option value="schrodinger">Schrödinger Equation Solver</option>
            <option value="fieldmapper">Electric Field & Potential Mapper</option>
            <option value="photoelectric">Photoelectric Effect</option>
            <option value="optics">Ray Optics</option>
        </select>

        <div id="optics-controls" class="ui-panel">
            <div class="control-group">
                <label>Instrument</label>
                <select id="opticsType" onchange="updateOptics()">
                    <option value="mirror">Mirror</option>
                    <option value="lens">Lens</option>
                </select>
            </div>
            <div class="control-group">
                <label>Curvature</label>
                <select id="opticsShape" onchange="updateOptics()">
                    <option value="concave">Concave</option>
                    <option value="convex">Convex</option>
                </select>
            </div>
            <div class="control-group">
                <label>Object Distance (u)</label>
                <input type="range" id="objDist" min="-400" max="-10" value="-150">
            </div>
        </div>

        <div id="photoelectric-controls" class="ui-panel">
            <div class="control-group">
                <label>Metal Element</label>
                <select id="peMetal" onchange="updateMetalProperties()">
                    <option value="430, #e0e0e0, 2.9">Lithium</option>
                    <option value="540, #f5f5dc, 2.3">Sodium</option>
                    <option value="550, #fff5ee, 2.25">Potassium</option>
                    <option value="590, #e6e6fa, 2.1">Rubidium</option>
                    <option value="650, #fdf5e6, 1.9">Caesium</option>
                    <option value="248, #95a5a6, 5.0">Beryllium</option>
                    <option value="335, #bdc3c7, 3.7">Magnesium</option>
                    <option value="430, #d7dbdd, 2.9">Cadmium</option>
                    <option value="477, #ecf0f1, 2.6">Strontium</option>
                    <option value="496, #aab7b8, 2.5">Barium</option>
                </select>
            </div>
            <div class="control-group">
                <label>Wavelength (nm)</label>
                <input type="number" id="peWavelength" value="400" min="100" max="800">
            </div>
            <div class="control-group">
                <label>Intensity (%)</label>
                <input type="number" id="peIntensity" value="50" min="0" max="100">
            </div>
        </div>

        <div id="schrodinger-controls" class="ui-panel">
            <div class="control-group">
                <label>Quantum State (n)</label>
                <input type="number" id="quantumN" min="1" max="10" value="1">
            </div>
        </div>

        <div id="fieldmapper-controls" class="ui-panel">
            <div class="control-group">
                <label>Charge A (q1)</label>
                <input type="number" id="chargeA" value="20">
                <div>
                    <button class="btn-toggle active" id="q1-pos" onclick="setPolarity(1, 1)">+</button>
                    <button class="btn-toggle" id="q1-neg" onclick="setPolarity(1, -1)">-</button>
                </div>
            </div>
            <div class="control-group">
                <label>Charge B (q2)</label>
                <input type="number" id="chargeB" value="20">
                <div>
                    <button class="btn-toggle active" id="q2-pos" onclick="setPolarity(2, 1)">+</button>
                    <button class="btn-toggle" id="q2-neg" onclick="setPolarity(2, -1)">-</button>
                </div>
            </div>
            <div class="control-group"><label>Separation (r)</label><input type="number" id="chargeDist" value="200"></div>
            <div class="control-group">
                <label>View Mode</label>
                <div>
                    <button class="btn-toggle active" id="btn-graph" onclick="setFieldView('graph')">1D Graphs</button>
                    <button class="btn-toggle" id="btn-vector" onclick="setFieldView('vector')">2D Vectors</button>
                </div>
            </div>
        </div>

        <div id="doubleslit-controls" class="ui-panel">
            <div class="control-group"><label>Frequency</label><input type="range" id="dsFreq" min="10" max="50" value="25"></div>
            <div class="control-group"><label>Slit Separation (d)</label><input type="range" id="dsClear" min="0" max="80" value="30"></div>
            <div class="control-group"><label>Source Distance</label><input type="range" id="dsSourceDist" min="50" max="300" value="200"></div>
            <div class="control-group"><label>Screen Distance (D)</label><input type="range" id="dsScreenDist" min="100" max="400" value="250"></div>
        </div>

        <div id="stern-controls" class="ui-panel">
            <div class="control-group"><label>Particle Speed</label><input type="range" id="sternSpeed" min="2" max="10" value="5" step="0.5"></div>
            <button class="btn-toggle" onclick="resetStern()">Reset Detector</button>
        </div>

        <div id="wave-controls" class="ui-panel">
            <div class="control-group">
                <label>Type</label>
                <div>
                    <button class="btn-toggle active" id="btn-const" onclick="setInterference('constructive')">Constructive</button>
                    <button class="btn-toggle" id="btn-dest" onclick="setInterference('destructive')">Destructive</button>
                </div>
            </div>
            <div class="control-group"><label>Wave A Amplitude</label><input type="range" id="ampA" min="10" max="80" value="40"></div>
            <div class="control-group"><label>Wave A Frequency</label><input type="range" id="freqA" min="10" max="100" value="20"></div>
            <div class="control-group"><label>Wave B Amplitude</label><input type="range" id="ampB" min="10" max="80" value="40"></div>
            <div class="control-group"><label>Wave B Frequency</label><input type="range" id="freqB" min="10" max="100" value="20"></div>
        </div>
    </div>

    <div id="canvas-wrapper">
        <div id="canvas-container"></div>
    </div>

    <div id="instruction-text">Please select a topic to begin visualization.</div>

    <script>
        let currentMode = "";
        let interferenceType = "constructive";
        let fieldViewMode = "graph";
        let q1Polarity = 1;
        let q2Polarity = 1;
        let t = 0;
        let particles = [];
        let detectionHits = [];
        let photons = [];
        let electrons = [];


        // Photoelectric Specific
        let currentWorkFunction = 430; // Default Lithium threshold
        let currentEnergy = 2.9;      // Default Lithium energy
        let metalColor = '#e0e0e0';

        function setup() {
            let canvasWidth = document.getElementById('canvas-wrapper').offsetWidth;
            const canvas = createCanvas(canvasWidth, 500);
            canvas.parent('canvas-container');
        }

        function draw() {
            background(10, 15, 25);
            if (currentMode === "waves") drawInterferenceSim();
            else if (currentMode === "stern") drawSternGerlach();
            else if (currentMode === "doubleslit") drawDoubleSlit();
            else if (currentMode === "schrodinger") drawSchrodinger();
            else if (currentMode === "fieldmapper") drawFieldMapper();
            else if (currentMode === "photoelectric") drawPhotoelectric();
            else if (currentMode === "optics") drawOptics();
            else drawIdleState();
        }

        function drawIdleState() {
            textAlign(CENTER, CENTER); fill(100); noStroke();
            text("Please select a topic to begin visualization.", width/2, height/2);
        }

        // --- OPTICS LOGIC ---
        function drawOptics() {
            let type = document.getElementById('opticsType').value;
            let shape = document.getElementById('opticsShape').value;
            let u = parseFloat(document.getElementById('objDist').value);
            let f = (shape === "concave") ? -80 : 80;
            if (type === "lens" && shape === "convex") f = 80; // Converging lens
            if (type === "lens" && shape === "concave") f = -80; // Diverging lens
            
            let centerX = width / 2;
            let centerY = height / 2;
            let objH = -60;

            // Principal Axis
            stroke(100); strokeWeight(1);
            line(50, centerY, width - 50, centerY);

            // Calculate v
            let v;
            if (type === "mirror") v = (f * u) / (u - f);
            else v = (f * u) / (u + f);
            
            let mag = (type === "mirror") ? -v / u : v / u;
            let imgH = objH * mag;

            // Draw Instrument
            stroke(varColor('--accent-color')); strokeWeight(3); noFill();
            if (type === "mirror") {
                if (shape === "concave") arc(centerX - 17, centerY, 32, 170, -HALF_PI, HALF_PI);
                else arc(centerX + 17, centerY, 31, 170, HALF_PI, -HALF_PI);
            } else {
                if (shape === "convex") { // Biconvex
                    beginShape();
                    vertex(centerX, centerY - 80);
                    bezierVertex(centerX + 30, centerY - 40, centerX + 30, centerY + 40, centerX, centerY + 80);
                    bezierVertex(centerX - 30, centerY + 40, centerX - 30, centerY - 40, centerX, centerY - 80);
                    endShape();
                } else { // Biconcave
                    beginShape();
                    vertex(centerX-15, centerY-80); bezierVertex(centerX, centerY-40, centerX, centerY+40, centerX-15, centerY+80);
                    vertex(centerX+15, centerY+80); bezierVertex(centerX, centerY+40, centerX, centerY-40, centerX+15, centerY-80);
                    endShape(CLOSE);
                }
            }

            // Focal points
            fill(255); noStroke();
            ellipse(centerX + f, centerY, 5, 5); text("F", centerX + f, centerY + 20);
            ellipse(centerX - f, centerY, 5, 5); text(type === "lens" ? "F'" : "F", centerX - f, centerY + 20);

            // Draw Object
            stroke(255, 255, 0); fill(255, 255, 0, 100);
            line(centerX + u, centerY, centerX + u, centerY + objH);
            triangle(centerX + u, centerY + objH, centerX + u - 5, centerY + objH + 10, centerX + u + 5, centerY + objH + 10);

            // Draw Rays (Two main rays)
            stroke(255, 100); strokeWeight(1);
            
            // Ray 1: Parallel then through focus
            line(centerX + u, centerY + objH, centerX, centerY + objH); 
            if (type === "mirror") line(centerX, centerY + objH, centerX + v, centerY + imgH);
            else line(centerX, centerY + objH, centerX + v, centerY + imgH);

            // Ray 2: Through optical center/pole
            line(centerX + u, centerY + objH, centerX, centerY);
            line(centerX, centerY, centerX + v, centerY + imgH);

            // Draw Image
            if (abs(v) < 2000) {
                stroke(0, 212, 255); fill(0, 212, 255, 100);
                line(centerX + v, centerY, centerX + v, centerY + imgH);
                let headDir = imgH < 0 ? 1 : -1;
                triangle(centerX + v, centerY + imgH, centerX + v - 5, centerY + imgH + (10 * headDir), centerX + v + 5, centerY + imgH + (10 * headDir));
            }
            
            fill(varColor('--secondary-text')); noStroke(); textAlign(LEFT);
            text("Object dist (u): " + round(u), 20, 40);
            text("Image dist (v): " + (isFinite(v) ? round(v) : "Infinity"), 20, 60);
            text("Magnification: " + (isFinite(mag) ? mag.toFixed(2) : "inf"), 20, 80);
        }

        function varColor(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        function updateMetalProperties() {
            let val = document.getElementById('peMetal').value.split(', ');
            currentWorkFunction = parseFloat(val[0]);
            metalColor = val[1];
            currentEnergy = parseFloat(val[2]);
            electrons = []; 
        }

        function drawPhotoelectric() {
            let wavelength = parseFloat(document.getElementById('peWavelength').value) || 400;
            let intensity = parseFloat(document.getElementById('peIntensity').value) || 0;
            let metalX = width * 0.7;

            // Metal Plate
            fill(metalColor); stroke(255, 50);
            rect(metalX, 100, 10, 300, 5);
            fill(255, 200); noStroke(); textAlign(CENTER);
            text("METAL PLATE", metalX + 7, 90);

            // Emit Continuous Beams based on Intensity
            let numBeams = floor(map(intensity, 0, 100, 0, 12));
            for(let i = 0; i < numBeams; i++) {
                let beamY = 120 + (i * 25);
                stroke(255, 255, 0, 180); noFill(); strokeWeight(1.5);
                
                beginShape();
                for(let x = 0; x <= metalX; x += 5) {
                    let waveOffset = sin(x * 0.15 - t * 8) * 6;
                    vertex(x, beamY + waveOffset);
                }
                endShape();

                if (wavelength < currentWorkFunction && frameCount % 12 === 0 && intensity > 0) {
                    let speed = map(wavelength, 100, currentWorkFunction, 7, 1.5);
                    electrons.push({ x: metalX, y: beamY, vx: -speed });
                }
            }
            strokeWeight(1);

            // Electron Physics
            for (let i = electrons.length - 1; i >= 0; i--) {
                let e = electrons[i];
                e.x += e.vx;
                fill(0, 212, 255); noStroke();
                ellipse(e.x, e.y, 6, 6);
                if (e.x < 0) electrons.splice(i, 1);
            }

            // UI Display for Threshold and Energy
            fill(255, 100); textAlign(LEFT);
            text("Threshold Wavelength (λ₀): " + currentWorkFunction + " nm", 20, 40);
            text("Work Function Energy (Φ): " + currentEnergy + " eV", 20, 60);
            
            let isEmitting = wavelength < currentWorkFunction;
            fill(isEmitting ? '#00d4ff' : '#ff4444');
            text("Status: " + (isEmitting ? "Emitting Electrons" : "No Emission (λ > λ₀)"), 20, 80);
            
            t += 0.05;
        }

        function drawFieldMapper() {
            let q1 = (parseFloat(document.getElementById('chargeA').value) || 0) * q1Polarity;
            let q2 = (parseFloat(document.getElementById('chargeB').value) || 0) * q2Polarity;
            let d = parseFloat(document.getElementById('chargeDist').value) || 0;
            let k = 5000; 

            let x1 = width/2 - d/2;
            let x2 = width/2 + d/2;
            let yMid = height/2;

            if (fieldViewMode === "graph") {
                noFill();
                stroke(255, 255, 0); 
                beginShape();
                for(let x = 0; x < width; x+=2) {
                    let r1 = abs(x - x1);
                    let r2 = abs(x - x2);
                    let v = k * (q1 / (r1 + 5) + q2 / (r2 + 5));
                    vertex(x, yMid - v/50);
                }
                endShape();

                stroke(0, 212, 255);
                beginShape();
                for(let x = 0; x < width; x+=2) {
                    let r1 = x - x1;
                    let r2 = x - x2;
                    let e = k * (q1 / (pow(r1, 2) + 100) * (r1 >= 0 ? 1 : -1) + q2 / (pow(r2, 2) + 100) * (r2 >= 0 ? 1 : -1));
                    vertex(x, yMid + 100 - e/5);
                }
                endShape();
                
                fill(255, 255, 0); noStroke(); textAlign(LEFT);
                text("Electric Potential (V)", 20, 40);
                fill(0, 212, 255);
                text("Electric Field (E Magnitude)", 20, 60);
            } else {
                for (let x = 0; x < width; x += 30) {
                    for (let y = 0; y < height; y += 30) {
                        let rVec1 = createVector(x - x1, y - yMid);
                        let rVec2 = createVector(x - x2, y - yMid);
                        let d1 = rVec1.mag();
                        let d2 = rVec2.mag();
                        
                        rVec1.normalize().mult(q1 * 1000 / (d1 * d1 + 10));
                        rVec2.normalize().mult(q2 * 1000 / (d2 * d2 + 10));
                        
                        let netE = p5.Vector.add(rVec1, rVec2);
                        let mag = netE.mag();
                        stroke(0, 212, 255, map(mag, 0, 10, 50, 255));
                        
                        push();
                        translate(x, y);
                        rotate(netE.heading());
                        let len = min(mag * 5, 20);
                        line(0, 0, len, 0);
                        // Draw arrowhead
                        if (len > 5) {
                            noStroke(); fill(0, 812, 255, map(mag, 0, 100, 50, 255));
                            triangle(len, 0, len - 4, 2, len - 4, -2);
                        }
                        pop();
                    }
                }
                fill(0, 212, 255); noStroke(); textAlign(LEFT);
                text("Electric Field Vectors (E)", 20, 40);
            }

            noStroke();
            fill(q1Polarity > 0 ? color(0, 212, 255) : color(255, 50, 50)); 
            ellipse(x1, yMid, 10 + abs(q1)/2);
            fill(q2Polarity > 0 ? color(200, 100, 255) : color(255, 50, 50)); 
            ellipse(x2, yMid, 10 + abs(q2)/2);
            fill(255); textAlign(CENTER); 
            text(q1Polarity > 0 ? "+q1" : "-q1", x1, yMid - 25); 
            text(q2Polarity > 0 ? "+q2" : "-q2", x2, yMid - 25);
        }

        function setPolarity(chargeNum, pol) {
            if (chargeNum === 1) {
                q1Polarity = pol;
                document.getElementById('q1-pos').classList.toggle('active', pol === 1);
                document.getElementById('q1-neg').classList.toggle('active', pol === -1);
            } else {
                q2Polarity = pol;
                document.getElementById('q2-pos').classList.toggle('active', pol === 1);
                document.getElementById('q2-neg').classList.toggle('active', pol === -1);
            }
        }

        function drawSternGerlach() {
            let speed = parseFloat(document.getElementById('sternSpeed').value);
            let magnetX = width * 0.4;
            let screenX = width * 0.7;
            let viewScreenX = width * 0.85;
            let viewScreenSize = 120;

            fill(255, 150); noStroke(); textAlign(CENTER); textSize(14);
            text("SCREEN VIEW", viewScreenX, height/2 - viewScreenSize/2 - 15);
            
            textAlign(LEFT); textSize(12);
            text("SOURCE", 20, height/2 - 40);
            text("MAGNETS", magnetX, 80);
            text("DETECTOR", 910, 35);

            fill(45, 55, 85); stroke(0, 212, 255, 100);
            rect(magnetX, 100, 60, 120, 5); 
            fill(255); noStroke(); textAlign(CENTER); textSize(20); text("N", magnetX + 30, 170);

            fill(45, 55, 85); stroke(0, 212, 255, 100);
            rect(magnetX, 280, 60, 120, 5);
            fill(255); noStroke(); text("S", magnetX + 30, 350);

            stroke(255, 50); line(screenX, 50, screenX, height - 50);

            fill(0); stroke(100);
            rect(viewScreenX - viewScreenSize/2, height/2 - viewScreenSize/2, viewScreenSize, viewScreenSize);
            
            for (let hit of detectionHits) {
                noStroke(); fill(0, 212, 255, 180);
                ellipse(viewScreenX + hit.offsetX, height/2 + hit.offsetY, 4, 4);
            }

            if (frameCount % 15 === 0) {
                particles.push({ x: 40, y: height/2, spin: random() > 0.5 ? -1 : 1, jitter: random(-1, 1) });
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                fill(255, 215, 0); noStroke();
                ellipse(p.x, p.y, 6, 6);
                p.x += speed;
                if (p.x > magnetX && p.x < magnetX + 60) p.y += (p.spin * 4) / speed;
                if (p.x >= screenX) {
                    detectionHits.push({ offsetY: p.y - height/2, offsetX: p.jitter * 10 });
                    particles.splice(i, 1);
                }
            }
        }

        function drawSchrodinger() {
            let n = parseInt(document.getElementById('quantumN').value) || 1;
            let wellWidth = width * 0.35;
            let h = 150;
            let psiX = width * 0.25;
            let probX = width * 0.75;
            let centerY = height * 0.5;

            textAlign(CENTER); noStroke(); fill(255, 200);
            text("Wavefunction ψₙ(x)", psiX, centerY - h - 20);
            text("Probability Density |ψₙ(x)|²", probX, centerY - h - 20);

            stroke(255, 50); noFill();
            rect(psiX - wellWidth/2, centerY - h, wellWidth, h*2);
            rect(probX - wellWidth/2, centerY - h, wellWidth, h*2);

            stroke(0, 212, 255); strokeWeight(2); beginShape();
            for(let x = 0; x <= wellWidth; x++) {
                let val = sin((n * PI * x) / wellWidth) * cos(t);
                vertex(psiX - wellWidth/2 + x, centerY - val * (h-20));
            }
            endShape();

            stroke(200, 100, 255); strokeWeight(3); beginShape();
            for(let x = 0; x <= wellWidth; x++) {
                let val = pow(sin((n * PI * x) / wellWidth), 2);
                vertex(probX - wellWidth/2 + x, (centerY + h) - val * (h*1.5));
            }
            endShape();
            t += 0.04;
        }

        function drawDoubleSlit() {
            let rawFreq = parseFloat(document.getElementById('dsFreq').value);
            let wavelength = 60 - rawFreq; 
            let d = parseFloat(document.getElementById('dsClear').value);
            let sDist = parseFloat(document.getElementById('dsSourceDist').value);
            let screenOffset = parseFloat(document.getElementById('dsScreenDist').value);
            let slitX = width / 2;
            let sourceX = slitX - sDist;
            let screenX = slitX + screenOffset;
            screenX = min(screenX, width - 15);

            fill(255, 255, 0); noStroke(); ellipse(sourceX, height/2, 15, 15);
            noFill(); stroke(255, 255, 0, 100);
            for(let r = 0; r < sDist; r += wavelength) {
                let rad = (r + (t * 20) % wavelength);
                ellipse(sourceX, height/2, rad * 2, rad * 2);
            }

            fill(100); noStroke();
            if (d === 0) {
                rect(slitX, 0, 10, height);
            } else {
                rect(slitX, 0, 10, height/2 - d/2 - 10);
                rect(slitX, height/2 + d/2 + 10, 10, height/2);
                rect(slitX, height/2 - 10, 10, 20);
            }

            if (d > 0) {
                noFill();
                for(let r = 0; r < (screenX - slitX); r += wavelength) {
                    let rad = (r + (t * 20) % wavelength);
                    stroke(0, 212, 255, 60);
                    arc(slitX + 5, height/2 - d/2, rad*2, rad*2, -PI/2, PI/2);
                    arc(slitX + 5, height/2 + d/2, rad*2, rad*2, -PI/2, PI/2);
                }
                for(let y = 0; y < height; y++) {
                    let relativeY = y - height/2;
                    let pathDiff = (d * relativeY) / (screenX - slitX);
                    let intensity = pow(cos(pathDiff * (PI/wavelength) * 8), 2);
                    stroke(0, 212, 255, intensity * 255);
                    line(screenX, y, screenX + 10, y);
                }
            }
            t += 0.05;
        }

        function drawInterferenceSim() {
            let ampA = parseFloat(document.getElementById('ampA').value);
            let freqA = parseFloat(document.getElementById('freqA').value) / 1000;
            let ampB = parseFloat(document.getElementById('ampB').value);
            let freqB = parseFloat(document.getElementById('freqB').value) / 1000;
            let phaseShift = (interferenceType === "constructive") ? 0 : PI;
            let midX = width * 0.4;
            stroke(40); line(midX, 0, midX, height);
            noFill(); stroke(0, 212, 255); beginShape();
            for (let x = 0; x < midX; x++) vertex(x, (height/4) + sin(x * freqA + t) * ampA);
            endShape();
            stroke(200, 100, 255); beginShape();
            for (let x = 0; x < midX; x++) vertex(x, (3*height/4) + sin(x * freqB + t + phaseShift) * ampB);
            endShape();
            stroke(255); strokeWeight(3); beginShape();
            for (let x = midX; x < width; x++) {
                let y1 = sin(x * freqA + t) * ampA;
                let y2 = sin(x * freqB + t + phaseShift) * ampB;
                vertex(x, height/2 + (y1 + y2));
            }
            endShape();
            strokeWeight(1); t += 0.05;
        }

        function showPanel(id, condition) {
            const panel = document.getElementById(id);
            if (condition) {
                panel.style.display = 'flex';
                requestAnimationFrame(() => panel.classList.add('show'));
            } else {
                panel.classList.add('show');
            panel.style.display = 'none';
            }
        }

        function handleTopicChange() {
            const val = document.getElementById('sim-selector').value;
            currentMode = val;
            showPanel('wave-controls', val === 'waves');
            showPanel('stern-controls', val === 'stern');
            showPanel('doubleslit-controls', val === 'doubleslit');
            showPanel('schrodinger-controls', val === 'schrodinger');
            showPanel('fieldmapper-controls', val === 'fieldmapper');
            showPanel('photoelectric-controls', val === 'photoelectric');
            showPanel('optics-controls', val === 'optics');
  
            let instr = document.getElementById('instruction-text');
            if (val === 'stern') instr.innerHTML = "<b>Stern-Gerlach:</b> Atoms split based on quantized spin.";
            else if (val === 'schrodinger') instr.innerHTML = "<b>Schrödinger:</b> Comparing wavefunction and probability density.";
            else if (val === 'doubleslit') instr.innerHTML = "<b>YDSE:</b> Higher frequency leads to more wavefronts in YDSE.";
            else if (val === 'waves') instr.innerHTML = "<b>Interference:</b> Combining two wave sources to show interference.";
            else if (val === 'fieldmapper') instr.innerHTML = "<b>Field Mapper:</b> Visualize Electric Field (E) and Potential (V). Arrows point from (+) to (-).";
            else if (val === 'photoelectric') instr.innerHTML = "<b>Photoelectric effect:</b> Select a metal. Only light with wavelength shorter than the threshold wavelength (λ₀) will eject electrons.";
            else if (val === 'optics') instr.innerHTML = "<b> Ray Optics:</b> Visualize the image formation using a mirror/lens.";
        }

        function setInterference(type) {
            interferenceType = type;
            document.getElementById('btn-const').classList.toggle('active', type === 'constructive');
            document.getElementById('btn-dest').classList.toggle('active', type === 'destructive');
        }

        function setFieldView(mode) {
            fieldViewMode = mode;
            document.getElementById('btn-graph').classList.toggle('active', mode === 'graph');
            document.getElementById('btn-vector').classList.toggle('active', mode === 'vector');
        }

        function resetStern() { detectionHits = []; particles = []; }

        function windowResized() {
            let canvasWidth = document.getElementById('canvas-wrapper').offsetWidth;
            resizeCanvas(canvasWidth, 500);
        }

        let greeted = false;

        window.addEventListener("load", () => {
        greeted = false; // reset on every refresh
        });

        document.addEventListener("pointerdown", () => {
            if (!greeted) {
                const audio = document.getElementById("greetingAudio");

                audio.currentTime = 0;   // rewind
                audio.volume = 0.8;

                audio.play()
                .then(() => console.log("Greeting played"))
                .catch(err => console.error("Audio blocked:", err));

            greeted = true;
            }
        }, { once: true });


    </script>

    <audio id="greetingAudio" preload="auto">
    <source src="./physics-greets-you.mp3" type="audio/mpeg">
    </audio>

</body>

</html>
